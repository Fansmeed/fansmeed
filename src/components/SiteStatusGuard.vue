<!-- SiteStatusGuard.vue - Fixed error display -->
<template>
    <!-- Error State -->
    <div v-if="showError"
        class="relative w-full h-screen bg-neutral-100 dark:bg-neutral-900 flex items-center justify-center">
        <div class="container mx-auto px-4 text-center">
            <ErrorDisplay 
                :error="displayError"
                @retry="retryLoad"
            />
        </div>
    </div>

    <!-- Show lockdown/maintenance page if active -->
    <div v-else-if="showStatusPage && !showError" class="site-status-page bg-background text-text">
        <div class="relative flex min-h-screen w-full flex-col items-center justify-center p-4 overflow-x-hidden">
            <!-- Logo/Brand -->
            <div class="flex justify-center mb-1">
                <svg width="120" height="190" viewBox="0 0 500 600" fill="currentColor"
                            xmlns="http://www.w3.org/2000/svg" class="h-15">
                            <!-- F Shape -->
                            <path
                                d="M0 0 C1 1 1 1 1.11352539 3.86743164 C1.10567017 5.74483032 1.10567017 5.74483032 1.09765625 7.66015625 C1.09515869 8.87582275 1.09266113 10.09148926 1.09008789 11.34399414 C1.08098389 12.90110107 1.07187988 14.45820801 1.0625 16.0625 C1.041875 20.991875 1.02125 25.92125 1 31 C-11.87 31 -24.74 31 -38 31 C-38 71.92 -38 112.84 -38 155 C-25.46 155 -12.92 155 0 155 C1 156 1 156 1.11352539 158.77563477 C1.10567017 160.59019165 1.10567017 160.59019165 1.09765625 162.44140625 C1.09515869 163.61646729 1.09266113 164.79152832 1.09008789 166.00219727 C1.08098389 167.50709717 1.07187988 169.01199707 1.0625 170.5625 C1.041875 175.326875 1.02125 180.09125 1 185 C-11.87 185 -24.74 185 -38 185 C-37.98839844 188.30902344 -37.97679687 191.61804688 -37.96484375 195.02734375 C-37.95705419 198.21769108 -37.95097686 201.40803737 -37.94506836 204.59838867 C-37.94002683 206.82267732 -37.93319377 209.04696263 -37.92456055 211.27124023 C-37.91248702 214.46078309 -37.90677004 217.65028229 -37.90234375 220.83984375 C-37.89718246 221.84087631 -37.89202118 222.84190887 -37.88670349 223.87327576 C-37.88662796 224.79415482 -37.88655243 225.71503387 -37.88647461 226.66381836 C-37.884254 227.47878281 -37.88203339 228.29374725 -37.87974548 229.13340759 C-38 231 -38 231 -39 232 C-40.84159023 232.09959621 -42.68696967 232.13080411 -44.53125 232.1328125 C-45.65144531 232.13410156 -46.77164063 232.13539063 -47.92578125 232.13671875 C-49.10527344 232.13285156 -50.28476563 232.12898437 -51.5 232.125 C-53.26923828 232.13080078 -53.26923828 232.13080078 -55.07421875 232.13671875 C-56.75451172 232.13478516 -56.75451172 232.13478516 -58.46875 232.1328125 C-59.50451172 232.13168457 -60.54027344 232.13055664 -61.60742188 232.12939453 C-64 232 -64 232 -65 231 C-65.09295815 229.55710213 -65.11746513 228.10970215 -65.11352539 226.66381836 C-65.11344986 225.7429393 -65.11337433 224.82206024 -65.11329651 223.87327576 C-65.10813522 222.87224319 -65.10297394 221.87121063 -65.09765625 220.83984375 C-65.0962413 219.82024063 -65.09482635 218.80063751 -65.09336853 217.75013733 C-65.08775097 214.47922893 -65.0751955 211.20838787 -65.0625 207.9375 C-65.05748726 205.72591244 -65.05292396 203.51432382 -65.04882812 201.30273438 C-65.03777583 195.86846346 -65.02049944 190.43424316 -65 185 C-70.61 185 -76.22 185 -82 185 C-82.99580078 183.09927734 -82.99580078 183.09927734 -84.01171875 181.16015625 C-84.90358943 179.4609079 -85.79551971 177.76169082 -86.6875 176.0625 C-87.12255859 175.23169922 -87.55761719 174.40089844 -88.00585938 173.54492188 C-90.61406071 168.57967934 -93.29017809 163.66873873 -96.09301758 158.81030273 C-97 157 -97 157 -97 155 C-86.44 155 -75.88 155 -65 155 C-65 104.18 -65 53.36 -65 1 C-20 0 -20 0 0 0 Z"
                                transform="translate(200,107) scale(1.5)" fill="white" stroke="currentColor"
                                stroke-width="4" />

                            <!-- M Shape -->
                            <path
                                d="M0 0 C0.928125 0.598125 1.85625 1.19625 2.8125 1.8125 C4.86931996 3.16751602 4.86931996 3.16751602 6.9375 2.9375 C9.21290088 1.97191679 9.21290088 1.97191679 11.875 0.0625 C17.40045373 -3.58429946 22.41627596 -4.32403471 28.9375 -4.25 C29.61490234 -4.25773437 30.29230469 -4.26546875 30.99023438 -4.2734375 C35.71954982 -4.25530014 39.5580545 -3.45941364 44 -2 C44 -1.34 44 -0.68 44 0 C44.556875 0.226875 45.11375 0.45375 45.6875 0.6875 C53.18890069 4.94505175 58.77066439 13.76011402 61.42090619 21.85930014 C63.15739354 28.27846428 63.14660334 35.06055212 63.12698364 41.66833496 C63.12932363 42.90387706 63.12932363 42.90387706 63.13171089 44.1643796 C63.13566914 46.89801658 63.13255156 49.63159708 63.12939453 52.36523438 C63.13075079 54.33535799 63.13253198 56.30548136 63.13470459 58.27560425 C63.13924984 63.60555332 63.13750198 68.93548296 63.1343255 74.26543236 C63.13178972 79.84366279 63.13414257 85.42189158 63.13571167 91.00012207 C63.13752859 100.35783181 63.1351383 109.71553365 63.13037109 119.07324219 C63.12491667 129.90531847 63.12670159 140.73737597 63.1321975 151.56945181 C63.13672707 160.86808734 63.13738033 170.16671721 63.13475883 179.46535349 C63.13319683 185.02029637 63.13300047 190.57523041 63.13629532 196.13017273 C63.13917218 201.34387219 63.13720179 206.55754724 63.13140106 211.77124405 C63.13007301 213.68977442 63.13046833 215.60830682 63.13266373 217.5268364 C63.13537315 220.13376389 63.13199683 222.74061183 63.12698364 225.34753418 C63.13032973 226.50124079 63.13032973 226.50124079 63.13374341 227.6782546 C63.1141507 232.8858493 63.1141507 232.8858493 62 234 C60.00035018 234.08758003 57.9976389 234.10696576 55.99609375 234.09765625 C54.78115234 234.09443359 53.56621094 234.09121094 52.31445312 234.08789062 C51.03505859 234.07951172 49.75566406 234.07113281 48.4375 234.0625 C47.15423828 234.05798828 45.87097656 234.05347656 44.54882812 234.04882812 C41.36583978 234.03699545 38.18294238 234.02051068 35 234 C33.45578326 230.91156653 33.87785929 227.66429106 33.89993286 224.27629089 C33.90119513 223.46956651 33.90245741 222.66284212 33.90375793 221.83167154 C33.9091596 219.11325181 33.92168742 216.39490985 33.93408203 213.67651367 C33.93927238 211.73361835 33.94398108 209.79072168 33.94824219 207.8478241 C33.95820102 203.65606161 33.97105735 199.46432122 33.98596573 195.27257347 C34.00897669 188.64667483 34.0223171 182.02077929 34.03366089 175.39485168 C34.06713848 156.55054901 34.10873565 137.70629044 34.17138672 118.86206055 C34.2058871 108.46058875 34.2297114 98.05914982 34.24159515 87.65762693 C34.24837441 82.1504579 34.26086392 76.64342808 34.28662491 71.13631248 C34.31085349 65.9563195 34.32127 60.77648534 34.32102966 55.59643745 C34.32345469 53.69409171 34.33104727 51.79174456 34.34415817 49.88944244 C34.36129943 47.29431295 34.35997605 44.69982437 34.35403442 42.10466003 C34.36345507 41.35018072 34.37287571 40.5957014 34.38258183 39.81835908 C34.34870176 35.40069243 33.83683319 32.45558796 31 29 C28 28.25 28 28.25 25 29 C17.82480431 36.62493117 20.87888811 52.57450818 20.91821289 62.47485352 C20.92177454 64.32542336 20.92485901 66.17599417 20.92750549 68.02656555 C20.93402362 71.99063339 20.94356073 75.95467813 20.95540047 79.9187336 C20.97376581 86.18327967 20.98331002 92.44782032 20.99131775 98.71238708 C21.01541963 116.51865046 21.0514934 134.32487979 21.09594727 152.13110352 C21.12046032 161.98106504 21.13784066 171.8310136 21.14750665 181.68100113 C21.15405972 187.91336099 21.16963704 194.14561364 21.19182408 200.37793648 C21.20351613 204.24247455 21.20691916 208.10698621 21.20792198 211.97154045 C21.21007719 213.76871876 21.21569514 215.56589661 21.2249527 217.36305237 C21.23706283 219.80756293 21.23699994 222.25177315 21.23377991 224.69630432 C21.24354161 225.77355824 21.24354161 225.77355824 21.25350052 226.87257487 C21.22821548 231.77178452 21.22821548 231.77178452 19 234 C16.38623047 234.22705078 16.38623047 234.22705078 13.1171875 234.1953125 C11.95058594 234.18886719 10.78398437 234.18242187 9.58203125 234.17578125 C8.35871094 234.15902344 7.13539063 234.14226562 5.875 234.125 C4.64394531 234.11597656 3.41289062 234.10695313 2.14453125 234.09765625 C-0.90383815 234.07402548 -3.95182382 234.04108054 -7 234 C-8.21003597 230.36989209 -8.12847722 227.06099042 -8.10679626 223.28338623 C-8.1059612 222.09251069 -8.1059612 222.09251069 -8.10510927 220.87757707 C-8.1020652 218.20839309 -8.09187656 215.53928315 -8.08178711 212.87011719 C-8.07823203 210.95987527 -8.07514575 209.04963243 -8.07249451 207.13938904 C-8.06593582 203.02076886 -8.05637122 198.90217024 -8.04459953 194.78356171 C-8.02633215 188.27044647 -8.01671417 181.75733652 -8.00868225 175.24420166 C-7.98451237 156.72153417 -7.94867717 138.19889865 -7.90405273 119.67626953 C-7.87949281 109.45019545 -7.86213736 99.22413399 -7.85249335 88.99803472 C-7.84595248 82.52454775 -7.830397 76.05116466 -7.80817592 69.57771349 C-7.79643529 65.54685751 -7.79307788 61.51602671 -7.79207802 57.48515511 C-7.78993266 55.61751898 -7.78434829 53.74988311 -7.7750473 51.88226891 C-7.7628283 49.32960741 -7.76301939 46.77723045 -7.76622009 44.22454834 C-7.75971229 43.48824967 -7.75320449 42.751951 -7.74649948 41.99334025 C-7.76952281 37.26368639 -8.53334333 33.44432366 -10 29 C-12.64 29 -15.28 29 -18 29 C-20.84521864 33.79285245 -21.43213097 37.77207597 -21.39199829 43.23164368 C-21.39793955 44.04460803 -21.40388081 44.85757238 -21.41000211 45.69517201 C-21.42627162 48.41060989 -21.42134895 51.12558839 -21.41650391 53.84106445 C-21.4238851 55.79104637 -21.43259047 57.74102366 -21.44252014 59.69099426 C-21.46583528 64.97981774 -21.47099199 70.26852384 -21.47317934 75.55739236 C-21.47883884 81.08763331 -21.50210949 86.61779768 -21.52377319 92.147995 C-21.56229381 102.61909508 -21.58651619 113.09017325 -21.60489786 123.56132621 C-21.63831985 142.33473486 -21.69592002 161.10807815 -21.75888956 179.88140839 C-21.78043488 186.47443435 -21.79567348 193.06743742 -21.80572915 199.66049063 C-21.81272292 203.75005859 -21.82359912 207.83961008 -21.83537102 211.92916679 C-21.83994724 213.83317859 -21.84278071 215.73719544 -21.84379387 217.64121246 C-21.84535429 220.22860084 -21.8529029 222.81590326 -21.86196899 225.40327454 C-21.86090074 226.16667674 -21.85983249 226.93007894 -21.85873187 227.71661454 C-21.8859636 232.8859636 -21.8859636 232.8859636 -23 234 C-24.91458282 234.09971786 -26.83282317 234.13080589 -28.75 234.1328125 C-29.9153125 234.13410156 -31.080625 234.13539063 -32.28125 234.13671875 C-33.5084375 234.13285156 -34.735625 234.12898437 -36 234.125 C-37.2271875 234.12886719 -38.454375 234.13273438 -39.71875 234.13671875 C-40.8840625 234.13542969 -42.049375 234.13414062 -43.25 234.1328125 C-44.32765625 234.13168457 -45.4053125 234.13055664 -46.515625 234.12939453 C-49 234 -49 234 -50 233 C-50.1044198 230.45391695 -50.14332639 227.934723 -50.14044189 225.38790894 C-50.14341302 224.58092753 -50.14638414 223.77394612 -50.1494453 222.94251072 C-50.15817191 220.21670912 -50.15964394 217.49095122 -50.16113281 214.76513672 C-50.16575861 212.81890773 -50.17078295 210.87267965 -50.17617798 208.92645264 C-50.18933692 203.61988915 -50.19575506 198.31333834 -50.20018864 193.00676107 C-50.20311698 189.68877205 -50.20722159 186.3707865 -50.21169281 183.05279922 C-50.22538405 172.66504744 -50.2350397 162.2773036 -50.2388947 151.88954341 C-50.24336354 139.91338623 -50.26084983 127.93734386 -50.2898953 115.96122158 C-50.31157258 106.69989474 -50.32160239 97.43860004 -50.32293582 88.17724812 C-50.32398059 82.64964397 -50.32981682 77.1221475 -50.34775543 71.59457016 C-50.36433813 66.38252687 -50.36634248 61.17067094 -50.35761642 55.95861053 C-50.35685117 54.05563731 -50.36112041 52.15265361 -50.37107468 50.24970627 C-50.45489022 33.2129276 -49.93169752 17.28176371 -37.75 4.1875 C-27.25690401 -5.65192771 -12.60945733 -7.69204369 0 0 Z"
                                transform="translate(305,105) scale(1.5)" fill="currentColor" stroke="currentColor"
                                stroke-width="1" class="text-primary" />

                            <text x="250" y="580" font-family="Lexend, sans-serif" font-size="120" text-anchor="middle"
                                fill="white" font-weight="bold">Fansmeed</text>
                        </svg>
            </div>

            <main class="layout-container flex h-full grow flex-col justify-center">
                <div class="px-2 flex flex-1 items-center justify-center py-3">
                    <div class="layout-content-container flex flex-col max-w-[960px] flex-1">
                        <div class="flex flex-col px-4 py-6">
                            <div class="flex flex-col items-center gap-6 text-center">
                                <!-- SVG Image based on status -->
                                <div class="flex items-center justify-center w-full max-w-[320px]">
                                    <div v-html="statusSVG" class="w-full flex justify-center h-auto"></div>
                                </div>

                                <div class="flex max-w-[520px] flex-col items-center gap-4">
                                    <h1 class="text-3xl font-bold leading-tight tracking-tighter">
                                        {{ statusTitle }}
                                    </h1>
                                    <p class="text-sm font-normal leading-normal opacity-80">
                                        {{ statusMessage }}
                                    </p>

                                    <p class="text-sm mt-2">
                                        For updates, contact us at:
                                        <a :href="`mailto:${contactInfo.contactEmail}`"
                                            class="text-primary font-semibold hover:underline">
                                            {{ contactInfo.contactEmail }}
                                        </a>
                                        <span class="px-2">Or call</span>
                                        <span v-if="contactInfo.contactPhoneNumbers && contactInfo.contactPhoneNumbers.length > 0">
                                            <a v-for="(phone, index) in contactInfo.contactPhoneNumbers" :key="index"
                                                :href="`tel:${phone}`"
                                                class="text-primary font-semibold hover:underline">
                                                {{ phone }}{{ index < contactInfo.contactPhoneNumbers.length - 1 ? ',' : '' }}
                                            </a>
                                        </span>
                                    </p>
                                </div>

                                <div class="flex flex-col items-center gap-4 mt-3">
                                    <p class="text-sm font-medium opacity-70">For live updates, follow us on social media:</p>
                                    <div class="flex gap-6">
                                        <li v-for="(icon, index) in socialIcons" :key="icon" class="list-none">
                                            <a :href="socialLinks[index]" target="_blank"
                                                class="text-text hover:text-primary transition-colors text-xl">
                                                <i :class="icon"></i>
                                            </a>
                                        </li>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Show app content if site is accessible -->
    <div v-else-if="!showError && hasInitialized" class="bg-background text-text">
        <slot />
    </div>
</template>

<script setup>
import { ref, computed, onMounted, onUnmounted, watch } from 'vue'
import { useClientSettingsStore, CLIENT_SETTINGS_OPERATIONS } from '@/stores/clientSettingsStore'
import { useUiStore } from '@/stores/uiStore'
import { useLoadingStore } from '@/stores/loading'
import { formatErrorForDisplay } from '@/utils/errorHelper'
import ErrorDisplay from '@/components/ErrorDisplay.vue'

const settingsStore = useClientSettingsStore()
const uiStore = useUiStore()
const loadingStore = useLoadingStore()
const emit = defineEmits(['status-checked', 'error'])

// Social media configuration
const socialIcons = [
    "fab fa-facebook-f",
    "fab fa-twitter",
    "fab fa-instagram",
    "fab fa-linkedin-in",
];

const socialLinks = [
    "https://facebook.com/fansmeed",
    "https://twitter.com/fansmeed",
    "https://instagram.com/fansmeed",
    "https://linkedin.com/company/fansmeed",
];

// SVG definitions
const statusSVGs = {
    lockdown: `<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200" viewBox="0 0 598.38259 519.36575" xmlns:xlink="http://www.w3.org/1999/xlink" role="img" artist="Katerina Limpitsouni" source="https://undraw.co/"><path d="M854.37384,671.40435l16.11882-5.113a54.56124,54.56124,0,0,0-.38831-26.249c-6.47575,14.3987-25.47463,17.92647-36.29963,29.419a32.81871,32.81871,0,0,0-8.3953,27.17926l-3.39124,11.504a54.99381,54.99381,0,0,0,40.024-22.76717,53.12122,53.12122,0,0,0,6.22435-11.78347C861.39249,672.90577,854.37384,671.40435,854.37384,671.40435Z" transform="translate(-300.34479 -190.05939)" fill="#f2f2f2"/><path d="M837.14986,650.13183l12.14673-11.765A54.56128,54.56128,0,0,0,837.24247,615.046c.62547,15.7755-14.806,27.40615-19.36941,42.52016a32.81867,32.81867,0,0,0,4.60727,28.07073l2.09524,11.809A54.99378,54.99378,0,0,0,850.245,659.2183a53.12068,53.12068,0,0,0,.31586-13.32264C844.10146,648.34548,837.14986,650.13183,837.14986,650.13183Z" transform="translate(-300.34479 -190.05939)" fill="#f2f2f2"/><path d="M756.405,224.54359H302.112a1.807,1.807,0,0,1,0-3.61319H756.405a1.807,1.807,0,0,1,0,3.61319Z" transform="translate(-300.34479 -190.05939)" fill="#3f3d56"/><ellipse cx="32.69152" cy="10.82345" rx="10.58751" ry="10.82345" fill="#3f3d56"/><ellipse cx="69.26654" cy="10.82345" rx="10.58751" ry="10.82345" fill="#3f3d56"/><ellipse cx="105.84156" cy="10.82345" rx="10.58751" ry="10.82345" fill="#3f3d56"/><path d="M734.38374,192.74209h-25.981a1.96762,1.96762,0,0,0,0,3.93446h25.981a1.96762,1.96762,0,0,0,0-3.93446Z" transform="translate(-300.34479 -190.05939)" fill="#3f3d56"/><path d="M734.38374,200.12647h-25.981a1.96761,1.96761,0,0,0,0,3.93445h25.981a1.96761,1.96761,0,0,0,0-3.93445Z" transform="translate(-300.34479 -190.05939)" fill="#3f3d56"/><path d="M734.38374,207.50114h-25.981a1.96761,1.96761,0,0,0,0,3.93445h25.981a1.96761,1.96761,0,0,0,0-3.93445Z" transform="translate(-300.34479 -190.05939)" fill="#3f3d56"/><circle cx="35.19338" cy="94.79521" r="13.08937" fill="#e6e7e8"/><path d="M668.86084,313.839H326.34674a3.89775,3.89775,0,1,1,0-7.7955h342.5141a3.89775,3.89775,0,1,1,0,7.7955Z" transform="translate(-300.34479 -190.05939)" fill="#e6e7e8"/><path d="M579.03041,329.241H326.34674a3.89794,3.89794,0,0,1,0-7.79588H579.03041a3.89794,3.89794,0,1,1,0,7.79588Z" transform="translate(-300.34479 -190.05939)" fill="#e6e7e8"/><circle cx="35.19338" cy="299.09983" r="13.08937" fill="#e6e7e8"/><path d="M668.86084,518.14363H326.34674a3.89775,3.89775,0,1,1,0-7.79549h342.5141a4.35939,4.35939,0,0,1,4.11419,4.19844A3.84941,3.84941,0,0,1,668.86084,518.14363Z" transform="translate(-300.34479 -190.05939)" fill="#e6e7e8"/><path d="M579.03041,533.54558H326.34674a3.89794,3.89794,0,0,1,0-7.79588H579.03041a3.89794,3.89794,0,1,1,0,7.79588Z" transform="translate(-300.34479 -190.05939)" fill="#e6e7e8"/><circle cx="35.19338" cy="189.24655" r="13.08937" fill="#e6e7e8"/><path d="M668.86084,408.29035H326.34674a3.89775,3.89775,0,1,1,0-7.7955h342.5141a3.89775,3.89775,0,1,1,0,7.7955Z" transform="translate(-300.34479 -190.05939)" fill="#e6e7e8"/><path d="M621.16327,423.6923H326.34674a3.89794,3.89794,0,0,1,0-7.79588H621.16327a3.89794,3.89794,0,0,1,0,7.79588Z" transform="translate(-300.34479 -190.05939)" fill="#e6e7e8"/><path d="M601.15322,439.09425H326.34674a3.89794,3.89794,0,0,1,0-7.79588H601.15322a3.89794,3.89794,0,1,1,0,7.79588Z" transform="translate(-300.34479 -190.05939)" fill="#e6e7e8"/><circle cx="306.49461" cy="324.42079" r="96.9336" fill="#fc5601"/><circle cx="306.36146" cy="344.39338" r="13.84766" fill="#3f3d56"/><circle cx="306.36146" cy="344.39338" r="6.39123" fill="#fc5601"/><path d="M632.41156,565.278h-51.144a19.12258,19.12258,0,0,1-19.10157-19.10059V522.72822a19.12342,19.12342,0,0,1,19.10157-19.10156h51.144a19.12331,19.12331,0,0,1,19.10107,19.10156v23.44922A19.12247,19.12247,0,0,1,632.41156,565.278Zm-51.144-59.65137a17.12113,17.12113,0,0,0-17.10157,17.10156v23.44922A17.12029,17.12029,0,0,0,581.26752,563.278h51.144a17.11986,17.11986,0,0,0,17.10107-17.10059V522.72822a17.1207,17.1207,0,0,0-17.10107-17.10156Z" transform="translate(-300.34479 -190.05939)" fill="#fff"/><path d="M578.23849,552.5493h45.39544a17.94254,17.94254,0,0,0,17.94256-17.94256V514.98319a17.86278,17.86278,0,0,0-1.18355-6.36529,17.895,17.895,0,0,1,7.13091,14.2951v19.62355a17.94254,17.94254,0,0,1-17.94257,17.94256H584.18585a17.93276,17.93276,0,0,1-16.759-11.57727A17.83961,17.83961,0,0,0,578.23849,552.5493Z" transform="translate(-300.34479 -190.05939)" fill="#3f3d56"/><polygon points="416.909 506.542 405.755 506.541 400.448 463.514 416.912 463.515 416.909 506.542" fill="#a0616a"/><path d="M717.64736,708.23783l-34.30291-.0013v-.43381a13.35238,13.35238,0,0,1,13.35164-13.35144h.00083l6.26586-4.75361,11.69073,4.75434,2.99442.0001Z" transform="translate(-300.34479 -190.05939)" fill="#2f2e41"/><polygon points="495.838 506.542 506.993 506.541 512.3 463.514 495.836 463.515 495.838 506.542" fill="#a0616a"/><path d="M795.79,708.23783l34.3029-.0013v-.43381a13.35238,13.35238,0,0,0-13.35164-13.35144h-.00083l-6.26586-4.75361L798.78385,694.452l-2.99442.0001Z" transform="translate(-300.34479 -190.05939)" fill="#2f2e41"/><path d="M700.302,621.95549c.16474-2.45511,1.47464-16.03273,1.47464-16.03273l3.13752-28.79462,5.52988-76.32805.36083-4.9965,28.96716-5.56128,19.79775-9.491,23.53141,7.52223,18.32311,6.87118s.03136,2.94142.17254,6.49469c.18825,4.65142.51767,10.35383,1.30205,11.83632,1.30991,2.61985.98048,16.68379.98048,16.68379s1.30205,28.61417,2.94143,31.7517,1.96875,9.67142,1.47464,10.98132,1.63937,35.6736,1.63937,35.6736,5.4758,60.811,2.04021,69.98042-16.41791,3.163-16.41791,3.163.62749-2.44726-3.13753-3.60033-15.2327-87.38-15.2327-87.38-2.13349-17.68-4.09444-22.747-3.765-19.30358-3.765-19.30358-12.11084-23.56282-12.26772-28.80248c0,0-1.58447-4.90237-3.08261.49417s-5.91421,18.32311-5.91421,18.32311l-4.30624,15.8758L738.68954,578.289l-3.2787,19.97034s-4.91023,26.50419-5.69461,27.6494,0,25.359,0,25.359-3.79638,20.62135-9.16156,24.22167-19.57964.05718-19.57964.05718S700.13728,624.41061,700.302,621.95549Z" transform="translate(-300.34479 -190.05939)" fill="#2f2e41"/><polygon points="412.315 236.13 418.755 255.528 410.809 264.987 414.308 268.588 411.727 273.678 404.997 327.032 441.894 341.025 454.319 325.447 464.116 341.025 506.81 330.593 495.922 262.556 495.922 258.108 492.848 249.519 492.848 231.337 500.966 177.215 476.736 168.728 465.151 159.559 461.402 172.454 445.44 169.615 445.024 159.927 432.811 171.466 422.527 174.399 410.213 177.215 408.644 181.137 411.781 180.353 411.272 231.377 412.315 236.13" fill="#2f2e41"/><path d="M701.63112,497.16362l6.19682-59.98181,1.63562-24.68654L692.11883,409.359s.68726,17.65162-1.58492,27.61085c-2.24226,9.82765-.29746,58.87688-.15891,60.18842a8.4387,8.4387,0,1,0,11.25612.00535Z" transform="translate(-300.34479 -190.05939)" fill="#a0616a"/><path d="M684.71257,449.61094l4.82391.99618,16.55046,3.42774.91771.18824,1.9531-7.76533,2.26687-2.41591,4.31409-22.60584.22745-1.17657,6.5182-13.93061,4.50971-41.87022-16.77006,3.012c-.08627.08627-.16474.18039-.24315.27451-2.40806,2.72963-4.12585,6.52605-6.93395,10.346-9.138,12.43246-16.14988,42.6389-15.87532,59.18936.00785.26666-.26671.55688-.59614.855A9.18008,9.18008,0,0,0,684.71257,449.61094Z" transform="translate(-300.34479 -190.05939)" fill="#2f2e41"/><path d="M809.45309,497.16362l-6.19682-59.98181-1.63562-24.68654,17.34473-3.13627s-.68726,17.65162,1.58492,27.61085c2.24226,9.82765.29746,58.87688.15891,60.18842a8.43869,8.43869,0,1,1-11.25612.00535Z" transform="translate(-300.34479 -190.05939)" fill="#a0616a"/><path d="M826.37164,449.61094l-4.82391.99618-16.55045,3.42774-.91772.18824-1.95309-7.76533-2.26688-2.41591L795.5455,421.436l-.22745-1.17657-6.5182-13.93061,1.4903-41.87022,10.77,3.012c.08627.08627.16474.18039.24316.27451,2.40805,2.72963,4.12584,6.52605,6.93394,10.346,9.138,12.43246,16.14988,42.6389,15.87532,59.18936-.00785.26666.26671.55688.59614.855A9.18008,9.18008,0,0,1,826.37164,449.61094Z" transform="translate(-300.34479 -190.05939)" fill="#2f2e41"/><path d="M737.489,370.65369l7.87971-20.6669,20.12717-.36864,6.67878,21.03554,24.0059,134.1036s-73.54408,20.48067-72.79806-4.13807c.78438-25.88455,4.32336-60.26788,4.32336-60.26788Z" transform="translate(-300.34479 -190.05939)" fill="#fc5601"/><circle cx="454.63748" cy="130.43677" r="23.70998" fill="#a0616a"/><path d="M729.87412,303.296c3.86011-4.2014,8.68826-11.892,23.31228-15.12147,18.07034-3.99055,26.60919,12.33362,22.05218,12.6012,13.32515,4.03514,4.76529,31.6106.94512,29.29792A1.12494,1.12494,0,0,1,776.08928,330,18.77,18.77,0,0,1,768.592,317.1934l-.725-6.52543c-.10351,5.30926-5.53035,6.01158-11.07409,4.05623a6.95535,6.95535,0,0,1,4.91385-4.83821,23.78593,23.78593,0,0,1-13.97147,6.07912,9.51087,9.51087,0,0,1,4.62511-6.36419l-.2188-.215a22.84961,22.84961,0,0,1-7.33,4.1504c-3.056.87594-6.71782.40207-8.81164-1.99015a6.50041,6.50041,0,0,1-1.25249-2.25409c.45268,4.2047-2.36752,9.00438-4.55825,8.18032C728.36675,317.11823,727.30441,306.0929,729.87412,303.296Z" transform="translate(-300.34479 -190.05939)" fill="#2f2e41"/><path d="M898.72738,708.23514a1.18647,1.18647,0,0,1-1.19006,1.19h-280.29a1.19,1.19,0,0,1,0-2.38h280.29A1.18651,1.18651,0,0,1,898.72738,708.23514Z" transform="translate(-300.34479 -190.05939)" fill="#ccc"/><path d="M607.62666,461.92192c-9.48085,0-17.81459,4.29206-22.5331,10.73464a29.12131,29.12131,0,0,1,17.37286-5.5744c14.68157,0,26.626,10.28436,26.626,22.92543v10.50777h5.16024v-15.668C634.25262,472.20628,622.30823,461.92192,607.62666,461.92192Z" transform="translate(-300.34479 -190.05939)" fill="#3f3d56"/><path d="M637.79828,505.89326h-61.918V487.67549c0-14.69824,13.88818-26.65625,30.959-26.65625s30.959,11.958,30.959,26.65625Zm-59.918-2h57.918V487.67549c0-13.5957-12.99073-24.65625-28.959-24.65625s-28.959,11.06055-28.959,24.65625Z" transform="translate(-300.34479 -190.05939)" fill="#fff"/><path d="M622.69671,498.93818H590.98187a5.38755,5.38755,0,0,1-5.38135-5.38183v-7.25c0-10.1084,9.52783-18.332,21.23877-18.332s21.23877,8.22363,21.23877,18.332v7.25A5.38754,5.38754,0,0,1,622.69671,498.93818Zm-15.85742-28.96386c-10.6084,0-19.23877,7.32617-19.23877,16.332v7.25a3.38525,3.38525,0,0,0,3.38135,3.38183h31.71484a3.38525,3.38525,0,0,0,3.38135-3.38183v-7.25C626.07806,477.30049,617.44769,469.97432,606.83929,469.97432Z" transform="translate(-300.34479 -190.05939)" fill="#fff"/></svg>`,
    maintenance: `<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200" viewBox="0 0 800 661.187" xmlns:xlink="http://www.w3.org/1999/xlink" role="img" artist="Katerina Limpitsouni" source="https://undraw.co/"><g transform="translate(-604 -249.388)"><path d="M926.654,741.64H128.347c-.468,0-.847-.5-.847-1.126s.379-1.126.847-1.126H926.654c.467,0,.847.5.847,1.126S927.121,741.64,926.654,741.64Z" transform="translate(476.5 163.634)" fill="#cbcbcb"/><path d="M4.753,0,28.6,6.653,21.925,30.746l-30.4-5.01Z" transform="translate(874.453 318.765)" fill="#ed9da0"/><rect width="21.736" height="22.812" transform="matrix(0.799, 0.602, -0.602, 0.799, 749.023, 829.795)" fill="#ed9da0"/><path d="M11.656,38.742H60.149A27.968,27.968,0,0,0,72.193,36l8.94-4.3a5.369,5.369,0,0,0-.894-10.013L61.8,16.584,30.245,0l-.024.12c-.59,2.988-1.5,7.5-1.618,7.777-3.235,3.707-6.559,5.415-9.879,5.078-5.79-.587-9.64-7.274-9.678-7.341l-.029-.052-.059.006A3.84,3.84,0,0,0,5.977,7.213c-1.321,1.992-.516,5.059-.383,5.522C4.012,14.283,3.3,22.927,3.247,23.628.96,26.052-.127,28.383.012,30.556A7.461,7.461,0,0,0,3.14,35.8a13.543,13.543,0,0,0,8.512,2.948Z" transform="matrix(0.799, 0.602, -0.602, 0.799, 739.921, 828.973)" fill="#090814"/><rect width="22.73" height="23.856" transform="translate(892.391 859.714)" fill="#ed9da0"/><path d="M414.137,620.461h50.712a29.248,29.248,0,0,0,12.6-2.87l9.349-4.493a5.614,5.614,0,0,0-.935-10.471l-19.286-5.337-33-17.343-.025.125c-.617,3.125-1.573,7.846-1.692,8.133-3.384,3.877-6.86,5.663-10.331,5.31-6.055-.614-10.081-7.606-10.121-7.677l-.03-.054-.062.007a4.016,4.016,0,0,0-3.117,1.7c-1.382,2.083-.539,5.291-.4,5.775-1.655,1.618-2.4,10.658-2.454,11.391-2.392,2.535-3.529,4.973-3.384,7.245a7.8,7.8,0,0,0,3.271,5.482,14.163,14.163,0,0,0,8.9,3.082Z" transform="translate(482.326 284.81)" fill="#090814"/><path d="M892.977,526.726H595.338a8.975,8.975,0,0,1-8.965-8.965V417.353a8.975,8.975,0,0,1,8.965-8.965H892.977a8.975,8.975,0,0,1,8.965,8.965V517.761a8.975,8.975,0,0,1-8.965,8.965Z" transform="translate(390.255 121.383)" fill="#fc5601"/><rect width="78.892" height="8.965" transform="translate(1023.247 556.665)" fill="#f2f2f2"/><circle cx="5.379" cy="5.379" r="5.379" transform="translate(1200.754 556.665)" fill="#f2f2f2"/><circle cx="5.379" cy="5.379" r="5.379" transform="translate(1218.684 556.665)" fill="#f2f2f2"/><circle cx="5.379" cy="5.379" r="5.379" transform="translate(1236.613 556.665)" fill="#f2f2f2"/><path d="M892.977,639.78H595.338a8.976,8.976,0,0,1-8.965-8.965V530.407a8.975,8.975,0,0,1,8.965-8.965H892.977a8.975,8.975,0,0,1,8.965,8.965V630.815a8.975,8.975,0,0,1-8.965,8.965Z" transform="translate(390.255 135.632)" fill="#e6e6e6"/><rect width="78.892" height="8.965" transform="translate(1023.247 683.969)" fill="#fc5601"/><circle cx="5.379" cy="5.379" r="5.379" transform="translate(1200.754 683.969)" fill="#fc5601"/><circle cx="5.379" cy="5.379" r="5.379" transform="translate(1218.684 683.969)" fill="#fc5601"/><circle cx="5.379" cy="5.379" r="5.379" transform="translate(1236.613 683.969)" fill="#fc5601"/><path d="M892.977,752.835H595.338a8.976,8.976,0,0,1-8.965-8.965V643.461a8.975,8.975,0,0,1,8.965-8.965H892.977a8.975,8.975,0,0,1,8.965,8.965V743.87A8.975,8.975,0,0,1,892.977,752.835Z" transform="translate(390.255 149.881)" fill="#e6e6e6"/><rect width="78.892" height="8.965" transform="translate(1023.247 811.273)" fill="#fc5601"/><circle cx="5.379" cy="5.379" r="5.379" transform="translate(1200.754 811.273)" fill="#fc5601"/><circle cx="5.379" cy="5.379" r="5.379" transform="translate(1218.684 811.273)" fill="#fc5601"/><circle cx="5.379" cy="5.379" r="5.379" transform="translate(1236.613 811.273)" fill="#fc5601"/><path d="M779.9,321.431l-.329-.243-.008-.006a4.027,4.027,0,0,0-5.634.832l-66.995,90.2h-7.371v-1.732a1.611,1.611,0,0,0-1.611-1.611h-4.4a1.611,1.611,0,0,0-1.611,1.611v1.732H689.4v-1.732a1.611,1.611,0,0,0-1.611-1.611h-4.4a1.611,1.611,0,0,0-1.611,1.611v1.732h-2.537v-1.732a1.611,1.611,0,0,0-1.611-1.611h-4.4a1.611,1.611,0,0,0-1.611,1.611v1.732h-2.545v-1.732a1.611,1.611,0,0,0-1.611-1.611h-4.4a1.611,1.611,0,0,0-1.611,1.611v1.732h-2.537v-1.732a1.611,1.611,0,0,0-1.611-1.611h-4.4a1.611,1.611,0,0,0-1.611,1.611v1.732h-2.545v-1.732a1.611,1.611,0,0,0-1.611-1.611h-4.4a1.611,1.611,0,0,0-1.611,1.611v1.732h-2.545v-1.732a1.611,1.611,0,0,0-1.611-1.611h-4.4a1.611,1.611,0,0,0-1.611,1.611v1.732h-2.537v-1.732a1.611,1.611,0,0,0-1.611-1.611h-4.4a1.611,1.611,0,0,0-1.611,1.611v1.732h-2.545v-1.732a1.611,1.611,0,0,0-1.611-1.611h-4.4a1.611,1.611,0,0,0-1.611,1.611v1.732h-2.537v-1.732a1.611,1.611,0,0,0-1.611-1.611h-4.4a1.611,1.611,0,0,0-1.611,1.611v1.732h-3.189a4.027,4.027,0,0,0-4.027,4.027v3.842a4.027,4.027,0,0,0,4.027,4.027H706.266a6,6,0,0,0,5.875-4.782l.042.03,68.543-92.287.006-.008a4.028,4.028,0,0,0-.832-5.634Z" transform="translate(391.126 110.292)" fill="#090814"/><path d="M459.982,301.438s-10.181-7.8-10.181,11.252l-1.607,62.96,17.95,59.477,10.449-19.29-4.287-41.795Z" transform="translate(361.284 107.704)" fill="#fc5601"/><path d="M576.211,456.635s11.806,57.493-3.148,104.676L565,736.947l-30.5,3.415L523.873,605.779l-10.232-66.9-21.25,61L422.345,728.95l-32.269-25.185s35.759-97.57,62.176-118.056l13.249-150.9Z" transform="translate(353.959 124.713)" fill="#090814"/><circle cx="34.55" cy="34.55" r="34.55" transform="translate(847.365 312.596) rotate(-61.337)" fill="#ed9da0"/><path d="M525.161,215.178c4.142.539,7.266-3.7,8.715-7.616s2.553-8.477,6.154-10.593c4.92-2.891,11.214.586,16.84-.368,6.353-1.077,10.484-7.81,10.808-14.246s-2.237-12.626-4.75-18.559l-.877,7.374a14.624,14.624,0,0,0-6.39-12.782l1.131,10.821a11.485,11.485,0,0,0-13.212-9.5l.178,6.447c-7.338-.873-14.74-1.746-22.1-1.082s-14.771,2.993-20.349,7.84c-8.344,7.25-11.391,19.189-10.368,30.2s5.566,21.346,10.3,31.334c1.191,2.513,2.839,5.349,5.6,5.669,2.482.288,4.754-1.787,5.525-4.164a15.092,15.092,0,0,0-.067-7.415c-.7-3.71-1.578-7.5-.922-11.219s3.331-7.391,7.078-7.847,7.582,3.828,5.78,7.145Z" transform="translate(366.648 91)" fill="#090814"/><path d="M442.685,314.316l-115.328-7.441,8.681-35.962,105.406,23.562Z" transform="translate(489.624 282.406)" fill="#cbcbcb"/><path d="M500.951,245.282l7.234-10.043s8.085,2.748,29.738,13.526l1.53,9.409,37.586,231.177L508.721,486.4l-18.6-.4-6.088-13.648-7.508,13.358-18.168-.387-18.486-10.717,18.218-55.726,5.894-50.9L454.87,320.03s-11.462-44.038,32.686-67.782Z" transform="translate(360.235 99.56)" fill="#fc5601"/><path d="M637.043,403.594A11.808,11.808,0,0,1,622.358,393l-40.532-10.857,16.305-14.478,35.99,12.529a11.872,11.872,0,0,1,2.922,23.4Z" transform="translate(389.682 116.251)" fill="#ed9da0"/><path d="M630.867,410.23a6.916,6.916,0,0,1-5.615.446l-66.676-25.306a71.2,71.2,0,0,1-38.321-32.3l-27.805-49.6a22.256,22.256,0,0,1,33.208-29.641l48.126,76.28,60.566,35.509a6.931,6.931,0,0,1,2.947,7.371l-3.012,12.763a6.917,6.917,0,0,1-2.1,3.547,6.845,6.845,0,0,1-1.316.932Z" transform="translate(366.15 103.486)" fill="#fc5601"/></g></svg>`
}

// State
const statusType = ref(null)
const hasInitialized = ref(false)
const retryCount = ref(0)

// Check if UI store has an error
const hasUiStoreError = computed(() => {
    return !!uiStore.getError(CLIENT_SETTINGS_OPERATIONS.LOAD_UI_SETTINGS) ||
           !!uiStore.getError(CLIENT_SETTINGS_OPERATIONS.START_UI_LISTENER)
})

// Get error from UI store with operation context
const uiStoreError = computed(() => {
    return uiStore.getError(CLIENT_SETTINGS_OPERATIONS.LOAD_UI_SETTINGS) ||
           uiStore.getError(CLIENT_SETTINGS_OPERATIONS.START_UI_LISTENER)
})

// Computed properties
const showError = computed(() => {
    return !!loadingStore.siteStatusError || hasUiStoreError.value
})

const displayError = computed(() => {
    // First check loading store error
    if (loadingStore.siteStatusError) {
        // If it's already a formatted error from uiStore, use it
        if (loadingStore.siteStatusError.operation) {
            return formatErrorForDisplay(loadingStore.siteStatusError)
        }
        // Otherwise, create a formatted error with operation context
        return formatErrorForDisplay({
            ...loadingStore.siteStatusError,
            operation: CLIENT_SETTINGS_OPERATIONS.LOAD_UI_SETTINGS
        })
    }
    
    // Check uiStore error
    if (uiStoreError.value) {
        return formatErrorForDisplay(uiStoreError.value)
    }
    
    return formatErrorForDisplay(new Error('Unknown error occurred'))
})

const contactInfo = computed(() => {
    const info = settingsStore.getContactInfo
    return info || { contactEmail: 'support@example.com', contactPhoneNumbers: [] }
})

// Use the site status from loadingStore
const siteStatus = computed(() => {
    return loadingStore.siteStatus
})

const showStatusPage = computed(() => {
    if (!siteStatus.value) return false
    return siteStatus.value.siteLockdown || siteStatus.value.maintenanceMode
})

const statusSVG = computed(() => {
    if (!siteStatus.value) return ''

    if (siteStatus.value.siteLockdown) {
        statusType.value = 'lockdown'
        return statusSVGs.lockdown
    } else if (siteStatus.value.maintenanceMode) {
        statusType.value = 'maintenance'
        return statusSVGs.maintenance
    }
    return ''
})

const statusTitle = computed(() => {
    const titles = {
        lockdown: "Site Lockdown Activated",
        maintenance: "Maintenance in Progress"
    }
    return titles[statusType.value] || ''
})

const statusMessage = computed(() => {
    const messages = {
        lockdown: "The site is currently under lockdown for security reasons. We'll be back online the moment everything has been resolved.",
        maintenance: "We're performing scheduled maintenance to improve your experience. We'll be back online as soon as possible."
    }
    return messages[statusType.value] || ''
})

// Watch for site status changes from the real-time listener
watch(siteStatus, (newStatus) => {
    if (newStatus) {
        // Emit event when status changes
        emit('status-checked', {
            isLockdown: newStatus.siteLockdown || false,
            isMaintenance: newStatus.maintenanceMode || false,
            isActive: newStatus.siteLockdown || newStatus.maintenanceMode
        })
    }
})

// Also watch for UI store errors
watch(hasUiStoreError, (hasError) => {
    if (hasError) {
        emit('error', uiStoreError.value)
    }
})

// Initialize settings
const initializeSettings = async () => {
    // Clear any previous errors
    uiStore.clearError(CLIENT_SETTINGS_OPERATIONS.LOAD_UI_SETTINGS)
    uiStore.clearError(CLIENT_SETTINGS_OPERATIONS.START_UI_LISTENER)
    
    // Start loading
    loadingStore.startLoading()
    
    try {
        retryCount.value++

        // Limit retries
        if (retryCount.value > 3) {
            const error = new Error('Maximum retry attempts reached. Please check your Firebase permissions.')
            error.operation = CLIENT_SETTINGS_OPERATIONS.LOAD_UI_SETTINGS
            throw error
        }

        // Load settings initially
        if (!settingsStore.uiSettings) {
            await settingsStore.loadUiSettings()
        }

        // Start the real-time listener if not already started
        if (!settingsStore.isListening.uiSettings) {
            await settingsStore.startUiSettingsListener()
        }

        // Get initial site status from loadingStore (which was set by loadUiSettings)
        const status = loadingStore.siteStatus
        
        // Mark as initialized
        hasInitialized.value = true

        // Emit initial event
        if (status) {
            emit('status-checked', {
                isLockdown: status.siteLockdown || false,
                isMaintenance: status.maintenanceMode || false,
                isActive: status.siteLockdown || status.maintenanceMode
            })
        }
        
    } catch (error) {
        console.error('Error initializing site status:', error)
        
        // Ensure error has operation context
        if (!error.operation) {
            error.operation = CLIENT_SETTINGS_OPERATIONS.LOAD_UI_SETTINGS
        }
        
        emit('error', error)
        // Note: loadingStore.setSiteStatusError was already called by clientSettingsStore
    }
}

// Retry loading
const retryLoad = async () => {
    retryCount.value = 0
    await initializeSettings()
}

// Lifecycle hooks
onMounted(() => {
    initializeSettings()
})

onUnmounted(() => {
    // We DON'T stop the listener here because we want it to continue running
    // Only clear uiStore timeouts
    uiStore.clearTimeoutForOperation(CLIENT_SETTINGS_OPERATIONS.LOAD_UI_SETTINGS)
    uiStore.clearTimeoutForOperation(CLIENT_SETTINGS_OPERATIONS.START_UI_LISTENER)
})
</script>